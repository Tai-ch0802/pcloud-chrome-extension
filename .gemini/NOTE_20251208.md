# Session Note - 2025-12-08

## Session Overview
本次 session 主要完成了 PDF Viewer 的深度整合，實現了在 Chrome PDF 檢視器中使用懸浮按鈕將 PDF 儲存至 pCloud 或轉換為 Markdown。同時修復了 Domain Rules 的路徑匹配 Bug，並將此修復應用於所有上傳功能（包含 PDF 上傳）。

## Completed Tasks

### 1. PDF Viewer 整合 (Feature)
**功能實作：**
- **懸浮介面 (Floating Overlay)**：在 PDF 頁面右上角注入一個半透明的 pCloud 按鈕，Hover 時變為不透明並放大。
- **雙重功能**：
  - **Save PDF to pCloud**：直接將當前 PDF 檔案上傳至 pCloud。
  - **Download as Markdown** (Premium)：利用 `pdf.js` 在前端將 PDF 內容轉換為 Markdown 並上傳。
- **檔案名稱解析**：實作了多重 fallback 機制來決定檔案名稱：
  1. `Content-Disposition` Header
  2. URL 路徑中的檔名
  3. `document.title`
  4. 預設名稱 `document_timestamp.pdf`
- **使用者回饋**：使用與 content script 一致的 Toast Notification 取代 blocking alert。

**關鍵技術：**
- 由於 Chrome 對 `<embed>` 的限制，無法直接注入按鈕到 PDF Viewer 的 Shadow DOM 內部，因此改用覆蓋在 `document.body` 上的 DOM 元素。
- 在 `manifest.json` 中注入 `pdf.js` 和 `pdf.worker.js` 以支援前端 PDF 解析。

### 2. Domain Rules 路徑匹配修復 (Bug Fix)
**問題診斷：**
- 原有的 Regex 生成邏輯只針對 `hostname` 進行匹配。
- 當使用者設定如 `attachment.domain.com/path/*` 的規則時，因為 Regex 只比對域名部分，導致無法正確匹配路徑。

**解決方案：**
- **重構匹配邏輯**：建立 shared utility `matchDomainRule` (在 `src/core/utils.js`)。
- **邏輯更新**：
  - 如果規則包含 `/` (路徑分隔符)，則將 Regex 應用於完整 URL (去除 protocol)。
  - 如果規則僅為域名，則保持僅比對 Hostname。
  - 正確處理 `*` 通配符轉換為 `.*`。

**影響範圍：**
- **Domain Rules 選項頁面**：更新測試邏輯。
- **圖片上傳** (`imageUploadUtils.js`)：更新匹配邏輯。
- **文件/文字上傳** (`contextMenuDocumentDownloader.js`, `contextMenuTextUploader.js`)：更新匹配邏輯。
- **PDF 上傳** (`service-worker.js`)：新增匹配邏輯。

### 3. 將 Domain Rules 應用於 PDF 上傳
**實作內容：**
- 修改 `pdf-viewer.js` 在發送 `startUploadFromFile` 訊息時附帶 `sourceUrl` (即當前 PDF 網址)。
- 修改 `service-worker.js` 的上傳處理邏輯：
  - 接收 `sourceUrl`。
  - 使用 `matchDomainRule` 檢查是否符合任何上傳規則。
  - 若符合，解析 `targetPath` 並轉換為 Folder ID (必要時自動建立資料夾)。
  - 將解析出的 `folderId` 傳遞給 `initiateUpload`。

## Files Modified

### Core / Logic
- `src/core/utils.js` (Created): 新增 `matchDomainRule` 共用函式。
- `src/core/pdf-to-markdown.js` (Created): PDF 轉 Markdown 核心邏輯。
- `src/background/service-worker.js`: 整合 Domain Rules 至 PDF 上傳流程。

### Content Scripts / UI
- `src/content/pdf-viewer.js` (Created): PDF Viewer 的 UI 注入與互動邏輯。
- `src/content/pdf-viewer.css` (Created): 懸浮按鈕與 Toast 樣式。
- `src/options/sections/domain-rules/index.js`: 修復測試與匹配邏輯。

### Features
- `src/features/free/imageUploadUtils.js`: 重構為使用 `matchDomainRule`。
- `src/features/free/contextMenuTextUploader.js`: 重構為使用 `matchDomainRule`。
- `src/features/paid/contextMenuDocumentDownloader.js`: 重構為使用 `matchDomainRule`。

### Configuration
- `manifest.json`: 註冊新的 content scripts 與 resources。
- `_locales/*/messages.json`: 新增 PDF 相關的 i18n 字串。

## Notes for Future Sessions
1. **Domain Rules**：現在是全域共用的邏輯，未來新增上傳功能時，請務必使用 `src/core/utils.js` 中的 `matchDomainRule` 來確保行為一致性。
2. **PDF Viewer**：目前是透過 URL 判斷與 Content Type 偵測來注入。如果未來 Chrome PDF Viewer 架構改變，可能需要維護注入邏輯。
