# Session Note - 2025-12-01

## Session Overview
本次 session 主要專注於修復和優化拖曳上傳功能，最終成功將上傳區塊從 iframe 重構為 Shadow DOM 架構，解決了文件選擇器和拖曳上傳的限制問題。

## Completed Tasks

### 1. 拖曳上傳功能調試與修復
**問題診斷：**
- 初始問題：拖曳圖片至上傳區塊時沒有反應，且缺少視覺回饋（綠色 + 號游標）
- 根本原因：iframe 的跨上下文限制導致 `dataTransfer` 資料無法傳遞，drop 事件無法正確觸發

**解決方案演進：**
1. **第一階段**：嘗試透過 `postMessage` 在主頁面和 iframe 之間傳遞拖曳資料
   - 在 `dragstart` 時儲存圖片 URL
   - 透過 `postMessage` 通知 iframe
   - iframe 接收後在 drop 時使用

2. **第二階段**：發現 drop 事件無法傳遞到 iframe，改為在主頁面的 `dragend` 事件判斷位置
   - 使用 `getBoundingClientRect()` 檢查滑鼠座標
   - 如果在 iframe 範圍內則直接觸發上傳
   - **此方案成功運作**

**關鍵修改：**
- `src/content/content.js`: 在 `dragend` 事件中加入座標檢測和上傳觸發邏輯
- 移除了對 drop 事件的依賴，改用 dragend + 位置判斷

### 2. Material Design 3 動畫整合
**實作內容：**
- 使用 MD3 Emphasized easing: `cubic-bezier(0.2, 0, 0, 1)`
- 動畫時長：400ms（符合 MD3 中等時長建議）
- 同時套用在 `transform` 和 `opacity` 屬性

**自動隱藏機制：**
- 拖曳結束後 5 秒自動淡出
- 滑鼠懸停時取消自動隱藏
- 滑鼠離開後重新開始 5 秒倒數

**修改檔案：**
- `src/content/content.css`: 更新 transition 使用 MD3 緩動函數
- `src/content/content.js`: 實作自動隱藏計時器邏輯

### 3. 關閉按鈕實作
**UI 設計：**
- 位置：右上角（top: 4px, right: 4px）
- 尺寸：24x24px（精緻不占空間）
- 圖示：16x16px 的 X 圖示
- 互動：MD3 風格的 hover/active 狀態

**功能：**
- 點擊後立即隱藏上傳區塊
- 取消任何待執行的自動隱藏計時器

**修改檔案：**
- `src/content/upload_ui.html`: 加入關閉按鈕 HTML
- `src/content/upload_ui.css`: 加入按鈕樣式
- `src/content/upload_ui.js`: 處理點擊事件並透過 `postMessage` 通知主頁面

### 4. Shadow DOM 重構（重大變更）
**問題背景：**
- iframe 方案的限制：
  1. 文件選擇器（`<input type="file">`）無法正常運作
  2. 從桌面拖曳檔案無法觸發上傳
  3. 跨上下文通訊複雜（需要 postMessage）
  4. 安全性限制較多

**解決方案：Shadow DOM**
- 優勢：
  1. ✅ 樣式完全隔離（同 iframe）
  2. ✅ 同一上下文（文件選擇器可用）
  3. ✅ 無需 postMessage
  4. ✅ 更輕量，性能更好

**重構範圍：**
1. **`src/content/content.js`** - 完全重寫
   - 創建 Shadow DOM: `attachShadow({ mode: 'open' })`
   - 將 CSS 和 HTML 內聯到 `shadowRoot.innerHTML`
   - 整合上傳列表渲染邏輯
   - 整合拖放和文件選擇邏輯
   - 保留所有現有功能（Toast、文件選擇、Word 生成等）

2. **`src/content/content.css`** - 簡化
   - 移除 iframe 相關樣式
   - 只保留 Toast 通知樣式
   - Shadow DOM 的樣式現在內嵌在 JS 中

3. **廢棄檔案**（不再需要，但未刪除以保留參考）：
   - `src/content/upload_ui.html`
   - `src/content/upload_ui.css`
   - `src/content/upload_ui.js`

**關鍵技術實作：**
```javascript
// Shadow DOM 創建
pcloudUploadShadow = pcloudUploadWidget.attachShadow({ mode: 'open' });

// CSS 和 HTML 注入
pcloudUploadShadow.innerHTML = `
  <style>
    :host { /* Shadow Host 樣式 */ }
    :host(.visible) { /* 可見狀態 */ }
    /* 所有內部樣式 */
  </style>
  <div class="upload-container">
    <!-- HTML 結構 -->
  </div>
`;

// 事件處理在同一上下文
const dropZone = pcloudUploadShadow.getElementById('drop-zone');
dropZone.addEventListener('drop', (e) => {
  // 直接存取 dataTransfer 和 files
});
```

**測試驗證：**
- ✅ 從網頁拖曳圖片到上傳區塊
- ✅ 點擊「選擇檔案」按鈕上傳
- ✅ 從桌面拖曳檔案到上傳區塊
- ✅ 關閉按鈕功能
- ✅ 自動隱藏功能
- ✅ `Cmd+U` 快捷鍵切換

## Technical Decisions

### 為何選擇 Shadow DOM 而非 iframe？
1. **功能完整性**：文件選擇器和本地檔案拖放都能正常運作
2. **同步性**：與主頁面在同一 JavaScript 上下文，無需 postMessage
3. **樣式隔離**：Shadow DOM 仍提供完整的 CSS 封裝
4. **性能優勢**：比 iframe 更輕量
5. **開發體驗**：除錯更容易，無需切換 context

### 遷移策略
採用「完全重寫」而非「漸進式修改」：
- **原因**：避免遺漏互動邏輯，確保功能完整性
- **風險控制**：保留舊檔案作為參考，可隨時回滾
- **成本**：約 600 行程式碼的重寫，但邏輯結構更清晰

## Files Modified

### Core Files
- `src/content/content.js` - 完全重寫（600+ 行），使用 Shadow DOM
- `src/content/content.css` - 移除 iframe 樣式，僅保留 Toast

### Deprecated (未刪除但不再使用)
- `src/content/upload_ui.html`
- `src/content/upload_ui.css`
- `src/content/upload_ui.js`

### No Change Required
- `manifest.json` - content.js 已在 manifest 中
- `service-worker.js` - 後端邏輯無需修改
- `_locales/*/messages.json` - i18n 字串保持不變

## Known Issues
無已知問題。所有功能均已驗證正常運作。

## Next Steps (if any)
- 可考慮刪除廢棄的 `upload_ui.*` 檔案以保持程式碼庫整潔
- 可進一步優化 Shadow DOM 內的 CSS（目前是內聯字串，可考慮外部化）

## Notes for Future Sessions
1. **Shadow DOM 注意事項**：
   - 事件監聽器需要在 shadow root 內部設置
   - i18n 初始化要在 Shadow DOM 載入後執行
   - `querySelector` 要使用 `shadowRoot.getElementById()` 
   
2. **拖曳上傳邏輯**：
   - 網頁圖片拖曳：使用 `dragend` + 座標判斷
   - 桌面檔案拖曳：使用 Shadow DOM 內的 `drop` 事件
   - 兩者邏輯已完全分離且獨立運作

3. **自動隱藏時機**：
   - 拖曳結束後 5 秒
   - 滑鼠離開後 5 秒
   - 都會檢查滑鼠是否仍在區塊上

## Gemini Performance Notes
本次 session 中遇到的挑戰：
- iframe 跨上下文問題的診斷花費較多時間
- 透過詳細的 console.log 調試找到根本原因
- 最終重構決定是在充分理解限制後做出的正確選擇
